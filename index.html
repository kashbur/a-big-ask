<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Big Reveal</title>
  <meta name="description" content="A fun, personalized surprise reveal experience. Play and discover your message!">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet"/>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      background: #f0f0f0;
      font-family: 'Poppins', sans-serif;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }
    .aspect-container {
      position: relative;
      width: 98vw;
      max-width: 430px;
      aspect-ratio: 9/16;
      background: #ddd;
      box-shadow: 0 6px 24px rgba(0,0,0,0.13);
      overflow: hidden;
      border-radius: 18px;
      display: flex; justify-content: center; align-items: center;
    }
    .slot-machine-container {
      position: absolute; width: 100%; height: 100%;
      top: 0; left: 0;
      display: flex; justify-content: center; align-items: center;
      overflow: visible;
    }
    .slot-machine {
      position: absolute; width: 100%; height: 100%;
      background-image: url('img/background.png');
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;
      transition: filter 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }
    .blur-background { filter: blur(8px);}
      .reel {
        position: absolute;
        width: 19.2%; height: 14.4%;
        top: 34.2%;
        background: transparent;
        display: flex; justify-content: center; align-items: center;
        z-index: 2;
        transition: filter 0.5s ease;
      }
    #reel1 { left: 20.4%; }
    #reel2 { left: 42.7%; }
    #reel3 { left: 65.1%; }
    .reel img {
      width: 85%; height: 85%;
      object-fit: contain;
      display: block;
      margin: auto;
      background: transparent;
      transition: transform 0.05s;
      box-shadow: none;
    }
      .spin-button {
        position: absolute;
        width: 34%; max-width: 170px;
        left: 50%; top: 62.5%;
        transform: translateX(-50%);
        cursor: pointer;
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.18));
        z-index: 3;
        transition: all 0.08s, filter 0.5s ease;
      }
    .spin-button img {
      width: 100%; height: auto; display: block;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
    }
    .spin-button.pressed, .spin-button:active {
      transform: translateX(-50%) scale(0.95);
    }
    .reveal-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(238, 222, 197, 0.93);
      display: flex; justify-content: center; align-items: center;
      z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s;
      flex-direction: column;
    }
    .reveal-overlay .color-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1;
      pointer-events: none;
      opacity: 0.53;
      background: transparent;
      transition: background 0.3s;
    }
    .reveal-content {
      position: relative;
      z-index: 2;
      width: 95%;
      max-width: 95vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .reveal-lines {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    .reveal-line {
      width: 100%;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      color: #fff;
      -webkit-text-stroke: 1.5px #8a6f56;
      text-shadow: 0 0 1px rgba(0,0,0,0.2);
      margin-bottom: 1em;
      opacity: 0;
      transform: translateY(16px);
      transition: opacity 0.7s, transform 0.7s;
    }
    .reveal-line.shown {
      opacity: 1;
      transform: translateY(0);
    }
    .reveal-line.photo img {
      width: 108px;
      height: 108px;
      /* Rounded avatar style */
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 1em;
      border: 4px solid #fff5;
      background: #f6f6f6;
      box-shadow: 0 2px 16px #0002;
    }
    .reveal-line.main { font-size: 2.15rem; font-weight: 900; margin-top: 0.16em;}
    .reveal-line.sub { font-size: 1.35rem; font-weight: 700; }
    .reveal-line.date { font-size: 1.14rem; font-weight: 700; }
    .reveal-line.from {
      font-size: 1rem;
      font-weight: 700;
      font-style: italic;
      margin-top: 2.5em;
      color: #fff;
      -webkit-text-stroke: 1.5px #8a6f56;
      text-shadow: 0 0 1px rgba(0,0,0,0.2);
    }
    @media (max-width:500px) {
      .aspect-container { max-width: 100vw; }
      .reveal-line {
        -webkit-text-stroke: 0.75px #8a6f56;
        text-shadow: 0 0 1px rgba(0,0,0,0.15);
      }
      .reveal-line.main { font-size: 1.75rem; }
      .reveal-line.sub { font-size: 1.35rem; }
      .reveal-line.date { font-size: 1.25rem; }
      .reveal-line.from {
        font-size: 1.2rem;
        -webkit-text-stroke: 0.75px #8a6f56;
        text-shadow: 0 0 1px rgba(0,0,0,0.15);
      }
      .reveal-content { max-width: 99vw; }
    }
    .confetti { position: absolute; z-index: 101; will-change: transform, opacity; pointer-events: none; }
    .confetti-square { width: 10px; height: 10px;}
    .confetti-rectangle { width: 8px; height: 16px;}
    .confetti-circle { width: 10px; height: 10px; border-radius: 50%;}
    /* Instructions Overlay */
    .instructions-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.68);
      display: flex; justify-content: center; align-items: center;
      z-index: 20; cursor: pointer; transition: opacity 0.4s;
    }
    .instructions-container {
      width: 97%; max-width: 340px; position: relative;
    }
    .instructions-image {
      width: 100%; height: auto; border-radius: 12px;
      /* box-shadow: none; */
      /* border: none; */
    }
  </style>
</head>
<body>
  <div class="aspect-container">
    <div class="slot-machine-container">
      <div class="slot-machine blur-background" id="slotMachine"></div>
      <div id="reel1" class="reel blur-background"><img src="img/ring.png" alt="Ring"></div>
      <div id="reel2" class="reel blur-background"><img src="img/graduation cap.png" alt="Graduation"></div>
      <div id="reel3" class="reel blur-background"><img src="img/briefcase.png" alt="Briefcase"></div>
      <div class="spin-button blur-background" id="spinButton">
        <img src="img/tap to spin.png" alt="Spin"/>
      </div>
      <div class="reveal-overlay" id="revealOverlay">
        <div class="color-overlay" id="colorOverlay"></div>
        <div class="reveal-content">
          <div class="reveal-lines" id="revealLines"></div>
        </div>
      </div>
      <div class="instructions-overlay" id="instructionsOverlay" style="opacity:1;">
        <div class="instructions-container">
          <img src="img/directions.png" alt="Instructions" class="instructions-image"/>
        </div>
      </div>
    </div>
  </div>
  <script>
    // -------------- URL Params Logic -------------
    function getParams() {
      const url = new URL(window.location.href);
      const params = {};
      for (const [k, v] of url.searchParams.entries()) {
        // Replace + with spaces to handle form submissions correctly
        params[k] = v.replace(/\+/g, ' ');
      }
      return params;
    }

    function getRevealLinesFromParams(params) {
      // Defaults
      const lines = [];
      const photo = params.photo ? decodeURIComponent(params.photo) : '';
      const main = params.main || "We're Expecting!";
      const sub = params.sub || "";
      const date = params.date || "";
      const from = params.from || "";
      if (main) lines.push({type: 'main', content: main});
      if (sub) lines.push({type: 'sub', content: sub});
      if (date) lines.push({type: 'date', content: date});
      if (photo) lines.push({type: 'photo', content: photo});
      if (from) lines.push({type: 'from', content: from});
      return lines;
    }
    function getColorOverlay(params) {
      // Pink, blue, yellow, green, purple, gold, none
      let color = (params.color || 'beige').toLowerCase();
      const overlays = {
        beige: 'rgba(238, 222, 197, 0.93)',
        pink: 'rgba(249, 185, 215, 0.93)',
        blue: 'rgba(173, 212, 253, 0.93)',
        yellow: 'rgba(254, 243, 199, 0.93)',
        green: 'rgba(203, 247, 208, 0.93)',
        purple: 'rgba(210, 197, 252, 0.93)',
        gold: 'rgba(255, 223, 154, 0.93)',
        none: 'transparent',
      };
      return overlays[color] || overlays.beige;
    }
    // ----------- Slot Machine Game Logic ----------
    document.addEventListener('DOMContentLoaded', function () {
      const icons = [
        "img/ring.png",
        "img/graduation cap.png",
        "img/briefcase.png",
        "img/house.png",
        "img/scroll.png",
        "img/baby-bottle.png",
        "img/box.png"
      ];
      let spinCount = 0;
      let currentSymbols = [icons[0], icons[1], icons[2]];
      const slotMachine = document.getElementById('slotMachine');
      const spinButton = document.getElementById('spinButton');
      const reel1 = document.getElementById('reel1');
      const reel2 = document.getElementById('reel2');
      const reel3 = document.getElementById('reel3');
      const revealOverlay = document.getElementById('revealOverlay');
      const revealLinesDiv = document.getElementById('revealLines');
      const colorOverlay = document.getElementById('colorOverlay');
      const instructionsOverlay = document.getElementById('instructionsOverlay');
      const params = getParams();

      // Set overlay color on reveal
      colorOverlay.style.background = getColorOverlay(params);

      // Hide instructions overlay
      function hideInstructionsOverlay() {
        instructionsOverlay.style.opacity = '0';
        slotMachine.classList.remove('blur-background');
        reel1.classList.remove('blur-background');
        reel2.classList.remove('blur-background');
        reel3.classList.remove('blur-background');
        spinButton.classList.remove('blur-background');
        instructionsOverlay.style.pointerEvents = 'none';
        setTimeout(() => {
          if (instructionsOverlay.parentNode) instructionsOverlay.parentNode.removeChild(instructionsOverlay);
        }, 400);
      }
      instructionsOverlay.addEventListener('click', hideInstructionsOverlay);
      instructionsOverlay.addEventListener('touchstart', function (e) {
        e.preventDefault();
        hideInstructionsOverlay();
      }, {passive:false});

      // Spin button interactions
      function playClickSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(210, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.14, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.14);
          oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
          oscillator.start(); oscillator.stop(audioContext.currentTime + 0.14);
        } catch (e) {}
      }
      spinButton.addEventListener('mousedown', function () {
        this.classList.add('pressed');
        if (navigator.vibrate) navigator.vibrate(24);
        playClickSound();
      });
      spinButton.addEventListener('mouseup', function () {
        this.classList.remove('pressed');
      });
      spinButton.addEventListener('mouseleave', function () { this.classList.remove('pressed'); });
      spinButton.addEventListener('touchstart', function (e) {
        e.preventDefault();
        this.classList.add('pressed');
        if (navigator.vibrate) navigator.vibrate(24);
        playClickSound();
      }, {passive:false});
      spinButton.addEventListener('touchend', function (e) {
        e.preventDefault();
        this.classList.remove('pressed');
        handleSpin();
      }, {passive:false});
      spinButton.addEventListener('click', handleSpin);

      function handleSpin() {
        spinCount++;
        spinButton.style.pointerEvents = 'none';
        const reel1Delay = 0, reel2Delay = 600, reel3Delay = 1200;
        if (spinCount === 4) {
          const babyBottle = icons[5];
          spinReelWithResult(reel1, babyBottle, reel1Delay);
          spinReelWithResult(reel2, babyBottle, reel2Delay);
          spinReelWithResult(reel3, babyBottle, reel3Delay, showReveal);
          currentSymbols = [babyBottle, babyBottle, babyBottle];
        } else {
          generateRandomNonMatchingSymbols();
          spinReelWithResult(reel1, currentSymbols[0], reel1Delay);
          spinReelWithResult(reel2, currentSymbols[1], reel2Delay);
          spinReelWithResult(reel3, currentSymbols[2], reel3Delay);
        }
        setTimeout(() => { spinButton.style.pointerEvents = 'auto'; }, reel3Delay + 900);
      }
      function generateRandomNonMatchingSymbols() {
        let idx = [];
        while (idx.length < 3) {
          let r = Math.floor(Math.random()*icons.length);
          if (!idx.includes(r)) idx.push(r);
        }
        currentSymbols = [icons[idx[0]], icons[idx[1]], icons[idx[2]]];
      }
      function spinReelWithResult(reel, finalIcon, delay, callback) {
        setTimeout(() => {
          const maxSpins = 26, spinInterval = 34, totalDuration = maxSpins * spinInterval;
          let startTime = null;
          function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = elapsed / totalDuration;
            const img = reel.querySelector('img');
            if (progress < 1) {
              const frameIndex = Math.floor(progress * maxSpins);
              if (frameIndex < maxSpins - 1) {
                img.src = icons[Math.floor(Math.random() * icons.length)];
                const scaleEffect = 1 + Math.sin(progress * Math.PI * 8) * 0.04;
                img.style.transform = `scale(${scaleEffect})`;
              } else {
                img.src = finalIcon;
                img.style.transform = 'scale(1)';
              }
              requestAnimationFrame(animate);
            } else {
              img.src = finalIcon;
              img.style.transform = 'scale(1)';
              if (callback && reel === reel3 && progress >= 1) setTimeout(callback, 300);
            }
          }
          requestAnimationFrame(animate);
        }, delay);
      }

      // ------------- REVEAL LOGIC -----------------
      function showReveal() {
        // 1. Clear any previous reveal lines!
        revealLinesDiv.innerHTML = '';

        // 2. Determine lines to reveal
        const revealLines = getRevealLinesFromParams(params);

        // Helper to create and show a line
        function revealLine(line, delay) {
          setTimeout(() => {
            const div = document.createElement('div');
            div.className = 'reveal-line ' + line.type;
            if (line.type === 'photo') {
              const img = document.createElement('img');
              img.src = line.content;
              img.alt = 'photo';
              img.onerror = () => { div.style.display = 'none'; };
              div.appendChild(img);
            } else {
              div.textContent = line.content;
            }
            revealLinesDiv.appendChild(div);
            setTimeout(() => div.classList.add('shown'), 70);
          }, delay);
          return delay;
        }

        let lastDelay = 0;
        // Display photo and main line immediately
        revealLines.forEach(line => {
          if (line.type === 'photo' || line.type === 'main') {
            lastDelay = Math.max(lastDelay, revealLine(line, 0));
          }
        });

        // Sub and date lines together after ~900ms
        revealLines.forEach(line => {
          if (line.type === 'sub' || line.type === 'date') {
            lastDelay = Math.max(lastDelay, revealLine(line, 900));
          }
        });

        // From line last, after another ~1700ms
        revealLines.forEach(line => {
          if (line.type === 'from') {
            lastDelay = Math.max(lastDelay, revealLine(line, 2600));
          }
        });

        // 4. Show overlay and confetti
        revealOverlay.style.opacity = '1';
        revealOverlay.style.pointerEvents = 'auto';
        createConfetti();
        setTimeout(() => {
          revealOverlay.style.opacity = '0';
          revealOverlay.style.pointerEvents = 'none';
        }, lastDelay + 30000);
      }
      // -------- Confetti logic (unchanged) ----------
      function createConfetti() {
        document.querySelectorAll('.confetti').forEach(el => { if (el.parentNode) el.parentNode.removeChild(el); });
        const colors = [
          '#FFD700', '#FFC125', '#EEC900', '#CDAD00', '#8B7500',
          '#DAA520', '#B8860B', '#A67C00', '#BDB76B', '#F0E68C',
          '#C0C0C0', '#D3D3D3', '#DCDCDC', '#E8E8E8', '#A9A9A9',
          '#B5B5B5', '#E0E0E0', '#F5F5F5', '#EBEBEB', '#CCCCCC'
        ];
        const container = document.querySelector('.slot-machine-container');
        const confettiElements = [];
        const viewportWidth = container.offsetWidth, viewportHeight = container.offsetHeight;
        const confettiCount = 64;
        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement('div');
          const shapeType = Math.floor(Math.random() * 3);
          confetti.className = shapeType === 0 ? 'confetti confetti-square' :
                               shapeType === 1 ? 'confetti confetti-rectangle' : 'confetti confetti-circle';
          const left = (i / confettiCount) * viewportWidth + (Math.random() * 16 - 8);
          const top = -18 - (Math.random() * 35);
          const size = 6 + Math.random() * 6;
          const scale = 0.7 + Math.random() * 0.6;
          const color = colors[Math.floor(Math.random() * colors.length)];
          const rotation = Math.random() * 360;
          confetti.style.left = `${left}px`;
          confetti.style.top = `${top}px`;
          if (shapeType === 0) { confetti.style.width = `${size}px`; confetti.style.height = `${size}px`; }
          else if (shapeType === 1) { confetti.style.width = `${size * 0.5}px`; confetti.style.height = `${size * 1.5}px`; }
          else { confetti.style.width = `${size}px`; confetti.style.height = `${size}px`; }
          confetti.style.backgroundColor = color;
          confetti.style.transform = `rotate(${rotation}deg) scale(${scale})`;
          confetti.style.boxShadow = '0 0 4px rgba(255,255,255,0.7)';
          container.appendChild(confetti);
          confettiElements.push({
            element: confetti,
            speed: 1.3 + Math.random() * 1.1,
            rotationSpeed: -0.5 + Math.random() * 1,
            horizontalDrift: -2 + Math.random() * 4,
            horizontalWobble: Math.random() * 2,
            wobbleSpeed: 0.25 + Math.random() * 0.45,
            floatFactor: 0.8 + Math.random() * 0.4,
            x: left, y: top, rotation: rotation,
            gravity: 0.05 + Math.random() * 0.04,
            airResistance: 0.97 + Math.random() * 0.02
          });
        }
        let lastTime = performance.now(), animationFrameId;
        function animateAllConfetti(currentTime) {
          const deltaTime = Math.min((currentTime - lastTime) / 16.67, 2);
          lastTime = currentTime;
          let activeConfetti = false;
          confettiElements.forEach(confetti => {
            if (confetti.y < viewportHeight + 44) {
              activeConfetti = true;
              confetti.speed += confetti.gravity * deltaTime;
              confetti.horizontalDrift *= confetti.airResistance;
              confetti.y += confetti.speed * deltaTime * confetti.floatFactor;
              confetti.x += confetti.horizontalDrift * 0.06 * deltaTime;
              const wobblePhase = confetti.y * 0.005 * confetti.wobbleSpeed;
              const wobble = Math.sin(wobblePhase) * confetti.horizontalWobble;
              confetti.rotation += confetti.rotationSpeed * 0.5 * deltaTime;
              const el = confetti.element;
              el.style.top = `${confetti.y}px`;
              el.style.left = `${confetti.x + wobble}px`;
              const scale = el.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1;
              el.style.transform = `rotate(${confetti.rotation}deg) scale(${scale})`;
              const shimmer = 0.8 + Math.sin(confetti.y * 0.006) * 0.18;
              if (confetti.y > viewportHeight - 120) {
                const fadeOut = 1 - Math.pow((confetti.y - (viewportHeight - 120)) / 120, 2);
                el.style.opacity = Math.max(0, fadeOut * shimmer);
              } else { el.style.opacity = shimmer; }
            } else if (confetti.element.parentNode) {
              confetti.element.parentNode.removeChild(confetti.element);
            }
          });
          if (activeConfetti) animationFrameId = requestAnimationFrame(animateAllConfetti);
          else confettiElements.forEach(confetti => { if (confetti.element.parentNode) confetti.element.parentNode.removeChild(confetti.element); });
        }
        animationFrameId = requestAnimationFrame(animateAllConfetti);
        setTimeout(() => {
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            document.querySelectorAll('.confetti').forEach(el => { if (el.parentNode) el.parentNode.removeChild(el); });
          }
        }, 8000);
      }
    });
  </script>
</body>
</html>
