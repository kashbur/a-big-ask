<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Big Reveal</title>
  <meta name="description" content="A fun, personalized surprise reveal experience. Play and discover your message!">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet"/>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      background: #f0f0f0;
      font-family: 'Poppins', sans-serif;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }
    .aspect-container {
      position: relative;
      width: 98vw;
      max-width: 430px;
      aspect-ratio: 9/16;
      background: #ddd;
      box-shadow: 0 6px 24px rgba(0,0,0,0.13);
      overflow: hidden;
      border-radius: 18px;
      display: flex; justify-content: center; align-items: center;
    }
    .slot-machine-container {
      position: absolute; width: 100%; height: 100%;
      top: 0; left: 0;
      display: flex; justify-content: center; align-items: center;
      overflow: visible;
    }
    .slot-machine {
      position: absolute; width: 100%; height: 100%;
      background-image: url('img/background.png');
      background-size: 100% 100%;
      background-position: center;
      background-repeat: no-repeat;
      transition: filter 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }
    .blur-background { filter: blur(8px);}
    .reel {
      position: absolute;
      width: 19.2%; height: 14.4%;
      top: 34.2%;
      background: transparent;
      display: flex; justify-content: center; align-items: center;
      z-index: 2;
    }
    #reel1 { left: 20.4%; }
    #reel2 { left: 42.7%; }
    #reel3 { left: 65.1%; }
    .reel img {
      width: 85%; height: 85%;
      object-fit: contain;
      display: block;
      margin: auto;
      background: transparent;
      transition: transform 0.05s;
      box-shadow: none;
    }
    .spin-button {
      position: absolute;
      width: 34%; max-width: 170px;
      left: 50%; top: 62.5%;
      transform: translateX(-50%);
      cursor: pointer;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.18));
      z-index: 3;
      transition: all 0.08s;
    }
    .spin-button img {
      width: 100%; height: auto; display: block;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
    }
    .spin-button.pressed, .spin-button:active {
      transform: translateX(-50%) scale(0.95);
    }
    .reveal-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(238, 222, 197, 0.93);
      display: flex; justify-content: center; align-items: center;
      z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .reveal-text {
      font-family: 'Poppins', sans-serif;
      width: 95%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .reveal-photo {
      width: 120px; height: 120px;
      object-fit: cover;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 3px 18px 0 rgba(60,0,30,0.09);
      display: block;
    }
    .reveal-line1 {
      font-size: 2.25rem;
      font-weight: 900;
      color: #fff;
      text-shadow: 2px 4px 0 #B59363, 0 2px 6px rgba(0,0,0,0.19);
      margin-bottom: 18px;
      line-height: 1.15;
    }
    .reveal-line2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 2px 4px 0 #B59363, 0 2px 6px rgba(0,0,0,0.14);
      margin-bottom: 12px;
      line-height: 1.13;
    }
    .reveal-line3 {
      font-size: 1.15rem;
      font-weight: 600;
      color: #fff;
      text-shadow: 1px 3px 0 #B59363, 0 2px 6px rgba(0,0,0,0.13);
      margin-bottom: 26px;
      line-height: 1.11;
    }
    .reveal-from {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      text-shadow: 1px 2px 0 #B59363, 0 2px 4px rgba(0,0,0,0.10);
      margin-top: 12px;
      margin-bottom: 2px;
      line-height: 1.11;
    }
    .confetti { position: absolute; z-index: 101; will-change: transform, opacity; pointer-events: none; }
    .confetti-square { width: 10px; height: 10px;}
    .confetti-rectangle { width: 8px; height: 16px;}
    .confetti-circle { width: 10px; height: 10px; border-radius: 50%;}
    .instructions-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.68);
      display: flex; justify-content: center; align-items: center;
      z-index: 20; cursor: pointer; transition: opacity 0.4s;
    }
    .instructions-container {
      width: 97%; max-width: 340px; position: relative;
    }
    .instructions-image {
      width: 100%; height: auto; border-radius: 12px; box-shadow: 0 2px 20px #0004;
      background: transparent;
      box-shadow: none;
    }
    .tap-to-continue {
      position: absolute; bottom: -40px; left: 0; width: 100%; text-align: center;
      color: white; font-size: 1.8rem; animation: pulse 1.4s infinite;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      text-shadow: 0 3px 9px #0009, 0 2px 4px #0008;
      letter-spacing: 1px;
    }
    @keyframes pulse { 0% {opacity:0.5;} 50% {opacity:1;} 100% {opacity:0.5;}}
    @media (max-width:500px) {
      .aspect-container { max-width: 100vw; }
      .instructions-container { max-width: 96vw;}
      .reveal-line1 { font-size: 1.34rem;}
      .reveal-line2 { font-size: 1.05rem;}
      .reveal-line3 { font-size: 0.97rem;}
      .reveal-from { font-size: 0.96rem;}
      .spin-button { width: 41%; }
      .tap-to-continue { font-size: 1.33rem; }
      .reveal-photo { width: 84px; height: 84px;}
    }
  </style>
</head>
<body>
  <div class="aspect-container">
    <div class="slot-machine-container">
      <div class="slot-machine blur-background" id="slotMachine"></div>
      <div id="reel1" class="reel"><img src="img/ring.png" alt="Ring"></div>
      <div id="reel2" class="reel"><img src="img/graduation cap.png" alt="Graduation"></div>
      <div id="reel3" class="reel"><img src="img/briefcase.png" alt="Briefcase"></div>
      <div class="spin-button" id="spinButton">
        <img src="img/tap to spin.png" alt="Spin"/>
      </div>
      <div class="reveal-overlay" id="revealOverlay">
        <div class="reveal-text" id="revealText"></div>
      </div>
      <div class="instructions-overlay" id="instructionsOverlay" style="opacity:1;">
        <div class="instructions-container">
          <img src="img/directions.png" alt="Instructions" class="instructions-image"/>
          <div class="tap-to-continue">Tap to continue</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ----------- REVEAL MESSAGE PARAMS & STAGGERED LAYOUT -----------
    function getParam(name, defaultValue = "") {
      const params = new URLSearchParams(window.location.search);
      const val = params.get(name);
      return (val && val.trim()) ? decodeURIComponent(val) : defaultValue;
    }
    function getOverlayColor(name) {
      const overlays = {
        pink: "rgba(238, 164, 205, 0.90)",
        blue: "rgba(130, 177, 255, 0.90)",
        peach: "rgba(238, 222, 197, 0.93)",
        gold: "rgba(251, 224, 154, 0.91)",
        green: "rgba(187, 242, 207, 0.91)",
        purple: "rgba(180, 167, 249, 0.91)",
        teal: "rgba(139, 221, 221, 0.91)",
        none: "rgba(255,255,255,0)",
      };
      return overlays[name] || overlays.peach;
    }
    function updateRevealContentFromParams() {
      const msg = getParam('msg', "We're Expecting!");
      const sub = getParam('sub', '');
      const date = getParam('date', '');
      const from = getParam('from', '');
      const overlay = getOverlayColor(getParam('overlay', 'peach'));
      const photo = getParam('photo', '');

      const revealOverlay = document.getElementById('revealOverlay');
      const revealText = document.getElementById('revealText');
      revealOverlay.style.backgroundColor = overlay;

      let html = '';
      if (photo && photo !== 'null') {
        html += `<img src="${photo}" class="reveal-photo" alt="Photo" />`;
      }
      html += `<div class="reveal-line1">${msg}</div>`;
      if (sub) html += `<div class="reveal-line2">${sub}</div>`;
      if (date) html += `<div class="reveal-line3">${date}</div>`;
      if (from) html += `<div class="reveal-from">Love, ${from}</div>`;
      revealText.innerHTML = html;
    }
    document.addEventListener('DOMContentLoaded', function () {
      updateRevealContentFromParams();

      // -------- INSTRUCTIONS OVERLAY --------
      const slotMachine = document.getElementById('slotMachine');
      const instructionsOverlay = document.getElementById('instructionsOverlay');
      function hideInstructionsOverlay() {
        instructionsOverlay.style.opacity = '0';
        slotMachine.classList.remove('blur-background');
        instructionsOverlay.style.pointerEvents = 'none';
        setTimeout(() => {
          if (instructionsOverlay.parentNode) instructionsOverlay.parentNode.removeChild(instructionsOverlay);
        }, 400);
      }
      instructionsOverlay.addEventListener('click', hideInstructionsOverlay);
      instructionsOverlay.addEventListener('touchstart', function (e) {
        e.preventDefault();
        hideInstructionsOverlay();
      }, {passive:false});

      // --------- SLOT MACHINE LOGIC ----------
      const icons = [
        "img/ring.png",
        "img/graduation cap.png",
        "img/briefcase.png",
        "img/house.png",
        "img/scroll.png",
        "img/baby-bottle.png",
        "img/box.png"
      ];
      let spinCount = 0;
      let currentSymbols = [icons[0], icons[1], icons[2]];
      const spinButton = document.getElementById('spinButton');
      const reel1 = document.getElementById('reel1');
      const reel2 = document.getElementById('reel2');
      const reel3 = document.getElementById('reel3');
      const revealOverlay = document.getElementById('revealOverlay');

      function playClickSound() {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(210, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.14, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.14);
          oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
          oscillator.start(); oscillator.stop(audioContext.currentTime + 0.14);
        } catch (e) {}
      }
      spinButton.addEventListener('mousedown', function () {
        this.classList.add('pressed');
        if (navigator.vibrate) navigator.vibrate(24);
        playClickSound();
      });
      spinButton.addEventListener('mouseup', function () {
        this.classList.remove('pressed');
      });
      spinButton.addEventListener('mouseleave', function () { this.classList.remove('pressed'); });
      spinButton.addEventListener('touchstart', function (e) {
        e.preventDefault();
        this.classList.add('pressed');
        if (navigator.vibrate) navigator.vibrate(24);
        playClickSound();
      }, {passive:false});
      spinButton.addEventListener('touchend', function (e) {
        e.preventDefault();
        this.classList.remove('pressed');
        handleSpin();
      }, {passive:false});
      spinButton.addEventListener('click', handleSpin);

      function handleSpin() {
        spinCount++;
        spinButton.style.pointerEvents = 'none';
        const reel1Delay = 0, reel2Delay = 600, reel3Delay = 1200;
        if (spinCount === 4) {
          const babyBottle = icons[5];
          spinReelWithResult(reel1, babyBottle, reel1Delay);
          spinReelWithResult(reel2, babyBottle, reel2Delay);
          spinReelWithResult(reel3, babyBottle, reel3Delay, showReveal);
          currentSymbols = [babyBottle, babyBottle, babyBottle];
        } else {
          generateRandomNonMatchingSymbols();
          spinReelWithResult(reel1, currentSymbols[0], reel1Delay);
          spinReelWithResult(reel2, currentSymbols[1], reel2Delay);
          spinReelWithResult(reel3, currentSymbols[2], reel3Delay);
        }
        setTimeout(() => { spinButton.style.pointerEvents = 'auto'; }, reel3Delay + 900);
      }
      function generateRandomNonMatchingSymbols() {
        let idx = [];
        while (idx.length < 3) {
          let r = Math.floor(Math.random()*icons.length);
          if (!idx.includes(r)) idx.push(r);
        }
        currentSymbols = [icons[idx[0]], icons[idx[1]], icons[idx[2]]];
      }
      function spinReelWithResult(reel, finalIcon, delay, callback) {
        setTimeout(() => {
          const maxSpins = 26, spinInterval = 34, totalDuration = maxSpins * spinInterval;
          let startTime = null;
          function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = elapsed / totalDuration;
            const img = reel.querySelector('img');
            if (progress < 1) {
              const frameIndex = Math.floor(progress * maxSpins);
              if (frameIndex < maxSpins - 1) {
                img.src = icons[Math.floor(Math.random() * icons.length)];
                const scaleEffect = 1 + Math.sin(progress * Math.PI * 8) * 0.04;
                img.style.transform = `scale(${scaleEffect})`;
              } else {
                img.src = finalIcon;
                img.style.transform = 'scale(1)';
                if (callback && reel === reel3) setTimeout(callback, 300);
              }
              requestAnimationFrame(animate);
            } else {
              img.src = finalIcon;
              img.style.transform = 'scale(1)';
              if (callback && reel === reel3 && progress >= 1) setTimeout(callback, 300);
            }
          }
          requestAnimationFrame(animate);
        }, delay);
      }
      function showReveal() {
        revealOverlay.style.opacity = '1';
        revealOverlay.style.pointerEvents = 'auto';
        createConfetti();
        setTimeout(() => {
          revealOverlay.style.opacity = '0';
          revealOverlay.style.pointerEvents = 'none';
        }, 4200);
      }
      function createConfetti() {
        document.querySelectorAll('.confetti').forEach(el => { if (el.parentNode) el.parentNode.removeChild(el); });
        const colors = [
          '#FFD700', '#FFC125', '#EEC900', '#CDAD00', '#8B7500',
          '#DAA520', '#B8860B', '#A67C00', '#BDB76B', '#F0E68C',
          '#C0C0C0', '#D3D3D3', '#DCDCDC', '#E8E8E8', '#A9A9A9',
          '#B5B5B5', '#E0E0E0', '#F5F5F5', '#EBEBEB', '#CCCCCC'
        ];
        const container = document.querySelector('.slot-machine-container');
        const confettiElements = [];
        const viewportWidth = container.offsetWidth, viewportHeight = container.offsetHeight;
        const confettiCount = 64;
        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement('div');
          const shapeType = Math.floor(Math.random() * 3);
          confetti.className = shapeType === 0 ? 'confetti confetti-square' :
                               shapeType === 1 ? 'confetti confetti-rectangle' : 'confetti confetti-circle';
          const left = (i / confettiCount) * viewportWidth + (Math.random() * 16 - 8);
          const top = -18 - (Math.random() * 35);
          const size = 6 + Math.random() * 6;
          const scale = 0.7 + Math.random() * 0.6;
          const color = colors[Math.floor(Math.random() * colors.length)];
          const rotation = Math.random() * 360;
          confetti.style.left = `${left}px`;
          confetti.style.top = `${top}px`;
          if (shapeType === 0) { confetti.style.width = `${size}px`; confetti.style.height = `${size}px`; }
          else if (shapeType === 1) { confetti.style.width = `${size * 0.5}px`; confetti.style.height = `${size * 1.5}px`; }
          else { confetti.style.width = `${size}px`; confetti.style.height = `${size}px`; }
          confetti.style.backgroundColor = color;
          confetti.style.transform = `rotate(${rotation}deg) scale(${scale})`;
          confetti.style.boxShadow = '0 0 4px rgba(255,255,255,0.7)';
          container.appendChild(confetti);
          confettiElements.push({
            element: confetti,
            speed: 1.3 + Math.random() * 1.1,
            rotationSpeed: -0.5 + Math.random() * 1,
            horizontalDrift: -2 + Math.random() * 4,
            horizontalWobble: Math.random() * 2,
            wobbleSpeed: 0.25 + Math.random() * 0.45,
            floatFactor: 0.8 + Math.random() * 0.4,
            x: left, y: top, rotation: rotation,
            gravity: 0.05 + Math.random() * 0.04,
            airResistance: 0.97 + Math.random() * 0.02
          });
        }
        let lastTime = performance.now(), animationFrameId;
        function animateAllConfetti(currentTime) {
          const deltaTime = Math.min((currentTime - lastTime) / 16.67, 2);
          lastTime = currentTime;
          let activeConfetti = false;
          confettiElements.forEach(confetti => {
            if (confetti.y < viewportHeight + 44) {
              activeConfetti = true;
              confetti.speed += confetti.gravity * deltaTime;
              confetti.horizontalDrift *= confetti.airResistance;
              confetti.y += confetti.speed * deltaTime * confetti.floatFactor;
              confetti.x += confetti.horizontalDrift * 0.06 * deltaTime;
              const wobblePhase = confetti.y * 0.005 * confetti.wobbleSpeed;
              const wobble = Math.sin(wobblePhase) * confetti.horizontalWobble;
              confetti.rotation += confetti.rotationSpeed * 0.5 * deltaTime;
              const el = confetti.element;
              el.style.top = `${confetti.y}px`;
              el.style.left = `${confetti.x + wobble}px`;
              const scale = el.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1;
              el.style.transform = `rotate(${confetti.rotation}deg) scale(${scale})`;
              const shimmer = 0.8 + Math.sin(confetti.y * 0.006) * 0.18;
              if (confetti.y > viewportHeight - 120) {
                const fadeOut = 1 - Math.pow((confetti.y - (viewportHeight - 120)) / 120, 2);
                el.style.opacity = Math.max(0, fadeOut * shimmer);
              } else { el.style.opacity = shimmer; }
            } else if (confetti.element.parentNode) {
              confetti.element.parentNode.removeChild(confetti.element);
            }
          });
          if (activeConfetti) animationFrameId = requestAnimationFrame(animateAllConfetti);
          else confettiElements.forEach(confetti => { if (confetti.element.parentNode) confetti.element.parentNode.removeChild(confetti.element); });
        }
        animationFrameId = requestAnimationFrame(animateAllConfetti);
        setTimeout(() => {
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            document.querySelectorAll('.confetti').forEach(el => { if (el.parentNode) el.parentNode.removeChild(el); });
          }
        }, 8000);
      }
    });
  </script>
</body>
</html>
